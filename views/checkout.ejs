<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    .checkout-item { display:flex; gap:16px; padding:12px 0; border-bottom:1px solid #eee; }
    .checkout-item img { width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #ddd; }
    .checkout-item-info h3 { margin:0 0 6px; font-size:1.05rem; }
    .qtd-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .btn-qtd { width:28px; height:28px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; line-height:1; font-weight:700; }
    .btn-qtd:disabled { opacity:.6; cursor:not-allowed; }
    .qtd { min-width:24px; text-align:center; display:inline-block; }
    .checkout-price { margin:2px 0; color:#333; }
    .total-container { margin-top:16px; padding-top:12px; border-top:2px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .empty { padding:24px 0; color:#666; }
    .btn-pagamento {
      background: #0077cc;
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    .btn-pagamento:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="checkout-container">
    <h1>ðŸ›’ Checkout</h1>

    <% if (itens && itens.length > 0) { %>
      <% let total = 0; %>
      <div id="checkout-list">
        <% itens.forEach(item => { %>
          <% total += Number(item.quantidade) * Number(item.produtos.preco); %>
          <div class="checkout-item" 
               data-item-id="<%= item.id %>" 
               data-preco="<%= Number(item.produtos.preco) %>">
            <img src="<%= (item.produtos.imagem_url || '').split(',')[0] %>" alt="Produto"
                 onerror="this.onerror=null;this.src='/images/placeholder.png';">

            <div class="checkout-item-info">
              <h3><%= item.produtos.nome %></h3>

              <div class="qtd-row">
                <span>Quantidade:</span>
                <button class="btn-qtd" type="button" data-action="minus">âˆ’</button>
                <span class="qtd"><%= Number(item.quantidade) %></span>
                <button class="btn-qtd" type="button" data-action="plus">+</button>
              </div>

              <p class="checkout-price">
                PreÃ§o unitÃ¡rio:
                <span class="unit">
                  <%= Number(item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>

              <p class="checkout-price">
                Subtotal:
                <span class="subtotal">
                  <%= Number(item.quantidade * item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="total-container">
        <h2>Total: 
          <span id="total-geral">
            <%= Number(total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
          </span>
        </h2>
      </div>
<div style="margin-top: 20px;">
<form method="GET" action="/checkout/frete">
  <button type="submit" class="btn-finalizar">Continuar para frete</button>
</form>
</div>

    <% } else { %>
      <p class="empty">Seu carrinho estÃ¡ vazio.</p>
    <% } %>
  </main>

  <%- include('partials/footer.ejs') %>

<script>
  const BRL = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  function atualizaSubtotalDoItem(itemNode) {
    const preco = Number(itemNode.dataset.preco || 0);
    const qtd = Number(itemNode.querySelector('.qtd')?.textContent || 0);
    const subtotalNode = itemNode.querySelector('.subtotal');
    if (subtotalNode) subtotalNode.textContent = BRL(preco * qtd);
  }

  function marcarCarrinhoVazioSePrecisar() {
    const list = document.getElementById('checkout-list');
    const pagarBtn = document.getElementById('btnPagarMP');
    if (!list) return;

    const itens = list.querySelectorAll('.checkout-item').length;
    if (itens === 0) {
      if (pagarBtn) pagarBtn.disabled = true;
      const container = document.querySelector('.checkout-container');
      if (!document.querySelector('.checkout-container .empty')) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Seu carrinho estÃ¡ vazio.';
        container.appendChild(empty);
      }
    }
  }

  function recalculaTotalGeral() {
    const list = document.getElementById('checkout-list');
    if (!list) return;

    let total = 0;
    list.querySelectorAll('.checkout-item').forEach(node => {
      const preco = Number(node.dataset.preco || 0);
      const qtd = Number(node.querySelector('.qtd')?.textContent || 0);
      total += preco * qtd;
    });

    const totalNode = document.getElementById('total-geral');
    if (totalNode) totalNode.textContent = BRL(total);

    const pagarBtn = document.getElementById('btnPagarMP');
    if (pagarBtn) pagarBtn.disabled = (list.querySelectorAll('.checkout-item').length === 0);
  }

  // Listeners de +/- quantidade
  document.querySelectorAll('.btn-qtd').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const itemNode = e.target.closest('.checkout-item');
      if (!itemNode) return;

      const itemId = itemNode.dataset.itemId;
      const action = e.target.dataset.action;
      const qtdSpan = itemNode.querySelector('.qtd');
      const qtdAtual = Number(qtdSpan.textContent);

      e.target.disabled = true;
      try {
        if (action === 'minus' && qtdAtual <= 1) {
          const resp = await fetch(`/api/carrinho/${itemId}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('Falha ao remover item.');
          itemNode.remove();
          marcarCarrinhoVazioSePrecisar();
        } else {
          const resp = await fetch(`/api/carrinho/${itemId}/${action}`, { method: 'POST' });
          if (!resp.ok) throw new Error('Falha ao atualizar quantidade.');
          const novaQtd = action === 'plus' ? (qtdAtual + 1) : (qtdAtual - 1);
          qtdSpan.textContent = String(novaQtd);
          atualizaSubtotalDoItem(itemNode);
        }
        recalculaTotalGeral();
      } catch (err) {
        console.error(err);
        alert('NÃ£o foi possÃ­vel atualizar este item agora.');
      } finally {
        e.target.disabled = false;
      }
    });
  });

  // Ir para pagamento (Bricks)
  document.getElementById('btnPagarMP')?.addEventListener('click', () => {
    // SÃ³ redireciona; o snapshot real do carrinho serÃ¡ lido no backend
    window.location.href = '/api/checkout/bricks';
  });

  // Estado inicial
  recalculaTotalGeral();
</script>
</body>
</html>
