<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    .checkout-item { display:flex; gap:16px; padding:12px 0; border-bottom:1px solid #eee; }
    .checkout-item img { width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #ddd; }
    .checkout-item-info h3 { margin:0 0 6px; font-size:1.05rem; }
    .qtd-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .btn-qtd { width:28px; height:28px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; line-height:1; font-weight:700; }
    .btn-qtd:disabled { opacity:.6; cursor:not-allowed; }
    .qtd { min-width:24px; text-align:center; display:inline-block; }
    .checkout-price { margin:2px 0; color:#333; }
    .total-container { margin-top:16px; padding-top:12px; border-top:2px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .empty { padding:24px 0; color:#666; }
    .btn-pagamento {
      background: #0077cc;
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    .btn-pagamento:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="checkout-container">
    <h1>ðŸ›’ Checkout</h1>

    <% if (itens && itens.length > 0) { %>
      <% let total = 0; %>
      <div id="checkout-list">
        <% itens.forEach(item => { %>
          <% total += Number(item.quantidade) * Number(item.produtos.preco); %>
          <div class="checkout-item" 
               data-item-id="<%= item.id %>" 
               data-preco="<%= Number(item.produtos.preco) %>">
            <img src="<%= (item.produtos.imagem_url || '').split(',')[0] %>" alt="Produto"
                 onerror="this.onerror=null;this.src='/images/placeholder.png';">

            <div class="checkout-item-info">
              <h3><%= item.produtos.nome %></h3>

              <div class="qtd-row">
                <span>Quantidade:</span>
                <button class="btn-qtd" type="button" data-action="minus">âˆ’</button>
                <span class="qtd"><%= Number(item.quantidade) %></span>
                <button class="btn-qtd" type="button" data-action="plus">+</button>
              </div>

              <p class="checkout-price">
                PreÃ§o unitÃ¡rio:
                <span class="unit">
                  <%= Number(item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>

              <p class="checkout-price">
                Subtotal:
                <span class="subtotal">
                  <%= Number(item.quantidade * item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="total-container">
        <h2>Total: 
          <span id="total-geral">
            <%= Number(total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
          </span>
        </h2>
      </div>

      <div style="margin-top: 20px;">
        <button id="btnPagarMP" class="btn-pagamento">Ir para pagamento</button>
      </div>
    <% } else { %>
      <p class="empty">Seu carrinho estÃ¡ vazio.</p>
    <% } %>
  </main>

  <%- include('partials/footer.ejs') %>

  <script>
    // ================
    // Helper global
    // ================
    const buyer = <%- JSON.stringify({
      name: (usuario && (usuario.nome || usuario.apelido)) || 'Cliente',
      email: (usuario && usuario.email) || 'teste@example.com'
    }) %>;

    const BRL = v => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // ================
    // Soma total
    // ================
    function recalculaTotalGeral() {
      const list = document.getElementById('checkout-list');
      let total = 0;
      if (!list) return;

      list.querySelectorAll('.checkout-item').forEach(node => {
        const preco = Number(node.dataset.preco || 0);
        const qtd = Number(node.querySelector('.qtd')?.textContent || 0);
        total += preco * qtd;
      });

      const totalNode = document.getElementById('total-geral');
      if (totalNode) totalNode.textContent = BRL(total);
    }

    // ================
    // Gera itens para o backend
    // ================
    function coletarItensDoDOM() {
      const list = document.getElementById('checkout-list');
      const itens = [];
      if (!list) return itens;

      list.querySelectorAll('.checkout-item').forEach(node => {
        const title = node.querySelector('h3')?.textContent?.trim() || 'Item';
        const quantity = Number(node.querySelector('.qtd')?.textContent || 1);
        const unit_price = Number(node.dataset.preco || 0);

        if (quantity > 0 && unit_price >= 0) {
          itens.push({ title, quantity, unit_price, currency_id: 'BRL' });
        }
      });
      return itens;
    }

    // ================
    // IntegraÃ§Ã£o Mercado Pago
    // ================
    async function pagarComMercadoPago() {
      const btn = document.getElementById('btnPagarMP');
      btn.disabled = true;

      try {
        const items = coletarItensDoDOM();
        if (!items.length) {
          alert('Seu carrinho estÃ¡ vazio.');
          btn.disabled = false;
          return;
        }

        const resp = await fetch('/api/checkout/create-preference', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items, buyer })
        });

        if (!resp.ok) throw new Error('Falha ao criar preferÃªncia.');

        const data = await resp.json();
        console.log('âœ… PreferÃªncia criada:', data);

        if (!data.init_point) throw new Error('Resposta invÃ¡lida do servidor.');

        // Redireciona ao checkout do Mercado Pago
        window.location.href = data.init_point;

      } catch (err) {
        console.error('Erro ao iniciar pagamento:', err);
        alert('NÃ£o foi possÃ­vel iniciar o pagamento agora. Tente novamente.');
      } finally {
        btn.disabled = false;
      }
    }

    // ================
    // Controle de quantidade
    // ================
    document.querySelectorAll('.btn-qtd').forEach(btn => {
      btn.addEventListener('click', async e => {
        const itemNode = e.target.closest('.checkout-item');
        if (!itemNode) return;

        const itemId = itemNode.dataset.itemId;
        const action = e.target.dataset.action;
        const qtdSpan = itemNode.querySelector('.qtd');
        const qtdAtual = Number(qtdSpan.textContent);

        e.target.disabled = true;

        try {
          if (action === 'minus' && qtdAtual <= 1) {
            await fetch(`/api/carrinho/${itemId}`, { method: 'DELETE' });
            itemNode.remove();
          } else {
            await fetch(`/api/carrinho/${itemId}/${action}`, { method: 'POST' });
            const novaQtd = action === 'plus' ? qtdAtual + 1 : qtdAtual - 1;
            qtdSpan.textContent = novaQtd;
          }
          recalculaTotalGeral();
        } catch (err) {
          console.error(err);
          alert('NÃ£o foi possÃ­vel atualizar este item agora.');
        } finally {
          e.target.disabled = false;
        }
      });
    });

    // ================
    // Inicializa
    // ================
    document.getElementById('btnPagarMP')?.addEventListener('click', pagarComMercadoPago);
    recalculaTotalGeral();
  </script>
</body>
</html>
