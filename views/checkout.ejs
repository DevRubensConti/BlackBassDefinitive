<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    /* Ajustes r√°pidos (opcional) */
    .checkout-item { display:flex; gap:16px; padding:12px 0; border-bottom:1px solid #eee; }
    .checkout-item img { width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #ddd; }
    .checkout-item-info h3 { margin:0 0 6px; font-size:1.05rem; }
    .qtd-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .btn-qtd { width:28px; height:28px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; line-height:1; font-weight:700; }
    .btn-qtd:disabled { opacity:.6; cursor:not-allowed; }
    .qtd { min-width:24px; text-align:center; display:inline-block; }
    .checkout-price { margin:2px 0; color:#333; }
    .total-container { margin-top:16px; padding-top:12px; border-top:2px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .empty { padding:24px 0; color:#666; }
  </style>
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="checkout-container">
    <h1>üõí Checkout</h1>

    <% if (itens && itens.length > 0) { %>
      <% let total = 0; %>
      <div id="checkout-list">
        <% itens.forEach(item => { %>
          <% total += Number(item.quantidade) * Number(item.produtos.preco); %>
          <div class="checkout-item" 
               data-item-id="<%= item.id %>" 
               data-preco="<%= Number(item.produtos.preco) %>">
            <img src="<%= (item.produtos.imagem_url || '').split(',')[0] %>" alt="Produto"
                 onerror="this.onerror=null;this.src='/images/placeholder.png';">

            <div class="checkout-item-info">
              <h3><%= item.produtos.nome %></h3>

              <div class="qtd-row">
                <span>Quantidade:</span>
                <button class="btn-qtd" type="button" data-action="minus" aria-label="Diminuir">‚àí</button>
                <span class="qtd"><%= Number(item.quantidade) %></span>
                <button class="btn-qtd" type="button" data-action="plus" aria-label="Aumentar">+</button>
              </div>

              <p class="checkout-price">
                Pre√ßo unit√°rio:
                <span class="unit">
                  <%= Number(item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>

              <p class="checkout-price">
                Subtotal:
                <span class="subtotal">
                  <%= Number(Number(item.quantidade) * Number(item.produtos.preco)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="total-container">
        <h2>Total: <span id="total-geral"><%= Number(total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %></span></h2>
      </div>
      <div>
<button id="btnPagarMP" class="btn-pagamento">Ir para pagamento</button>
      </div>
    <% } else { %>
      <p class="empty">Seu carrinho est√° vazio.</p>
    <% } %>
  </main>

  <%- include('partials/footer.ejs') %>
<script>
  // =========================
  // Helpers BRL / DOM + buyer (inje√ß√£o via EJS)
  // =========================
  const buyer = <%- JSON.stringify({
    name: (usuario && (usuario.nome || usuario.apelido)) || 'Cliente',
    email: (usuario && usuario.email) || 'teste@example.com'
  }) %>;

  const BRL = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  function recalculaTotalGeral() {
    const list = document.getElementById('checkout-list');
    let total = 0;

    if (!list) return;

    list.querySelectorAll('.checkout-item').forEach(node => {
      const preco = Number(node.dataset.preco || 0);
      const qtd = Number(node.querySelector('.qtd')?.textContent || 0);
      total += preco * qtd;
    });

    const totalNode = document.getElementById('total-geral');
    if (totalNode) totalNode.textContent = BRL(total);

    // Se n√£o h√° itens, mostrar vazio e desabilitar pagamento
    const isEmpty = list.querySelectorAll('.checkout-item').length === 0;
    const pagarBtn = document.getElementById('btnPagarMP');

    if (isEmpty) {
      const container = document.querySelector('.checkout-container');
      if (pagarBtn) pagarBtn.disabled = true;

      // evita duplicar a mensagem
      if (!document.querySelector('.checkout-container .empty')) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Seu carrinho est√° vazio.';
        container.appendChild(empty);
      }
    } else {
      if (pagarBtn) pagarBtn.disabled = false;
    }
  }

  function atualizaSubtotalDoItem(itemNode) {
    const preco = Number(itemNode.dataset.preco || 0);
    const qtd = Number(itemNode.querySelector('.qtd')?.textContent || 0);
    const subtotalNode = itemNode.querySelector('.subtotal');
    if (subtotalNode) subtotalNode.textContent = BRL(preco * qtd);
  }

  // =========================
  // Coleta itens do DOM p/ Mercado Pago
  // =========================
  function coletarItensDoDOM() {
    const list = document.getElementById('checkout-list');
    const itens = [];
    if (!list) return itens;

    list.querySelectorAll('.checkout-item').forEach(node => {
      const title = node.querySelector('.checkout-item-info h3')?.textContent?.trim() || 'Item';
      const quantity = Number(node.querySelector('.qtd')?.textContent || 1);
      const unit_price = Number(node.dataset.preco || 0);

      if (quantity > 0 && unit_price >= 0) {
        itens.push({
          title,
          quantity,
          unit_price,
          currency_id: 'BRL'
        });
      }
    });

    return itens;
  }

  // =========================
  // Inicia pagamento (Checkout Pro)
  // =========================
  async function pagarComMercadoPago() {
    const btn = document.getElementById('btnPagarMP');
    if (!btn) return;

    btn.disabled = true;

    try {
      const items = coletarItensDoDOM();
      if (!items.length) {
        alert('Seu carrinho est√° vazio.');
        btn.disabled = false;
        return;
      }

      const resp = await fetch('/api/checkout/create-preference', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, buyer })
      });

      if (!resp.ok) throw new Error('Falha ao criar prefer√™ncia.');

      const { init_point } = await resp.json();
      if (!init_point) throw new Error('Resposta inv√°lida do servidor.');

      // Redireciona para o Checkout do Mercado Pago
      window.location.href = init_point;

    } catch (err) {
      console.error(err);
      alert('N√£o foi poss√≠vel iniciar o pagamento agora. Tente novamente.');
      btn.disabled = false;
    }
  }

  // =========================
  // Listeners +/‚àí (mantidos)
  // =========================
  document.querySelectorAll('.checkout-item .btn-qtd').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const itemNode = e.target.closest('.checkout-item');
      if (!itemNode) return;

      const itemId = itemNode.dataset.itemId;
      const action = e.target.getAttribute('data-action');
      const qtdSpan = itemNode.querySelector('.qtd');
      const qtdAtual = Number(qtdSpan?.textContent || 1);

      e.target.disabled = true;

      try {
        if (action === 'minus' && qtdAtual <= 1) {
          // Remover o item
          const resp = await fetch(`/api/carrinho/${itemId}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('Falha ao remover item.');

          itemNode.remove();
          recalculaTotalGeral();
          return;
        } else {
          // Fluxo normal de +/- quantidade
          const resp = await fetch(`/api/carrinho/${itemId}/${action}`, { method: 'POST' });
          if (!resp.ok) throw new Error('Falha ao atualizar quantidade.');

          const novaQtd = action === 'plus' ? (qtdAtual + 1) : (qtdAtual - 1);
          qtdSpan.textContent = String(novaQtd);

          atualizaSubtotalDoItem(itemNode);
          recalculaTotalGeral();
        }
      } catch (err) {
        console.error(err);
        alert('N√£o foi poss√≠vel atualizar este item agora. Tente novamente.');
      } finally {
        e.target.disabled = false;
      }
    });
  });

  // =========================
  // Bind do bot√£o pagar + estado inicial
  // =========================
  const btnPagar = document.getElementById('btnPagarMP');
  if (btnPagar) {
    btnPagar.addEventListener('click', pagarComMercadoPago);
  }
  // garantir estado correto do bot√£o ao carregar
  recalculaTotalGeral();
</script>


</body>
</html>
