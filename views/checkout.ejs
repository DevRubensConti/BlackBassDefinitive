<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Checkout</title>
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    .checkout-item { display:flex; gap:16px; padding:12px 0; border-bottom:1px solid #eee; }
    .checkout-item img { width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #ddd; }
    .checkout-item-info h3 { margin:0 0 6px; font-size:1.05rem; }
    .qtd-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .btn-qtd { width:28px; height:28px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; line-height:1; font-weight:700; }
    .btn-qtd:disabled { opacity:.6; cursor:not-allowed; }
    .qtd { min-width:24px; text-align:center; display:inline-block; }
    .checkout-price { margin:2px 0; color:#333; }
    .total-container { margin-top:16px; padding-top:12px; border-top:2px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .empty { padding:24px 0; color:#666; }
    .btn-pagamento {
      background: #0077cc;
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    .btn-pagamento:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="checkout-container">
    <h1>üõí Checkout</h1>

    <% if (itens && itens.length > 0) { %>
      <% let total = 0; %>
      <div id="checkout-list">
        <% itens.forEach(item => { %>
          <% total += Number(item.quantidade) * Number(item.produtos.preco); %>
          <div class="checkout-item" 
               data-item-id="<%= item.id %>" 
               data-preco="<%= Number(item.produtos.preco) %>">
            <img src="<%= (item.produtos.imagem_url || '').split(',')[0] %>" alt="Produto"
                 onerror="this.onerror=null;this.src='/images/placeholder.png';">

            <div class="checkout-item-info">
              <h3><%= item.produtos.nome %></h3>

              <div class="qtd-row">
                <span>Quantidade:</span>
                <button class="btn-qtd" type="button" data-action="minus">‚àí</button>
                <span class="qtd"><%= Number(item.quantidade) %></span>
                <button class="btn-qtd" type="button" data-action="plus">+</button>
              </div>

              <p class="checkout-price">
                Pre√ßo unit√°rio:
                <span class="unit">
                  <%= Number(item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>

              <p class="checkout-price">
                Subtotal:
                <span class="subtotal">
                  <%= Number(item.quantidade * item.produtos.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </span>
              </p>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="total-container">
        <h2>Total: 
          <span id="total-geral">
            <%= Number(total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
          </span>
        </h2>
      </div>

      <div style="margin-top: 20px;">
        <button id="btnPagarMP" class="btn-pagamento">Ir para pagamento</button>
      </div>
    <% } else { %>
      <p class="empty">Seu carrinho est√° vazio.</p>
    <% } %>
  </main>

  <%- include('partials/footer.ejs') %>

<script>
  // =========================
  // Helpers / buyer
  // =========================
  const usuario = typeof window !== 'undefined' ? null : null; // s√≥ para n√£o quebrar minificadores
  const buyer = <%- JSON.stringify({
    name: (typeof usuario !== 'undefined' && usuario && (usuario.nome || usuario.apelido)) ? (usuario.nome || usuario.apelido) : (res.locals.usuario?.nome || res.locals.usuario?.apelido || 'Cliente'),
    email: (typeof usuario !== 'undefined' && usuario && usuario.email) ? usuario.email : (res.locals.usuario?.email || 'teste@example.com')
  }) %>;

  const BRL = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  function atualizaSubtotalDoItem(itemNode) {
    const preco = Number(itemNode.dataset.preco || 0);
    const qtd = Number(itemNode.querySelector('.qtd')?.textContent || 0);
    const subtotalNode = itemNode.querySelector('.subtotal');
    if (subtotalNode) subtotalNode.textContent = BRL(preco * qtd);
  }

  function marcarCarrinhoVazioSePrecisar() {
    const list = document.getElementById('checkout-list');
    const pagarBtn = document.getElementById('btnPagarMP');
    if (!list) return;

    const itens = list.querySelectorAll('.checkout-item').length;
    if (itens === 0) {
      if (pagarBtn) pagarBtn.disabled = true;
      const container = document.querySelector('.checkout-container');
      if (!document.querySelector('.checkout-container .empty')) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Seu carrinho est√° vazio.';
        container.appendChild(empty);
      }
    }
  }

  function recalculaTotalGeral() {
    const list = document.getElementById('checkout-list');
    if (!list) return;

    let total = 0;
    list.querySelectorAll('.checkout-item').forEach(node => {
      const preco = Number(node.dataset.preco || 0);
      const qtd = Number(node.querySelector('.qtd')?.textContent || 0);
      total += preco * qtd;
    });

    const totalNode = document.getElementById('total-geral');
    if (totalNode) totalNode.textContent = BRL(total);

    // habilita/desabilita bot√£o conforme houver itens
    const pagarBtn = document.getElementById('btnPagarMP');
    if (pagarBtn) pagarBtn.disabled = (list.querySelectorAll('.checkout-item').length === 0);
  }

  function coletarItensDoDOM() {
    const list = document.getElementById('checkout-list');
    const itens = [];
    if (!list) return itens;

    list.querySelectorAll('.checkout-item').forEach(node => {
      const title = node.querySelector('h3')?.textContent?.trim() || 'Item';
      const quantity = Number(node.querySelector('.qtd')?.textContent || 1);
      const unit_price = Number(node.dataset.preco || 0);
      if (quantity > 0 && unit_price >= 0) {
        itens.push({ title, quantity, unit_price, currency_id: 'BRL' });
      }
    });
    return itens;
  }

  async function pagarComMercadoPago() {
    const btn = document.getElementById('btnPagarMP');
    if (!btn) return;

    btn.disabled = true;
    try {
      const items = coletarItensDoDOM();
      if (!items.length) {
        alert('Seu carrinho est√° vazio.');
        btn.disabled = false;
        return;
      }

      const resp = await fetch('/api/checkout/create-preference', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, buyer })
      });

      let data = {};
      try { data = await resp.json(); } catch {}

      console.log('üßæ Resposta /create-preference:', { ok: resp.ok, status: resp.status, data });

      if (!resp.ok || !data?.init_point) {
        alert('Erro ao criar prefer√™ncia. Tente novamente.');
        btn.disabled = false;
        return;
      }

      // Redireciona ao checkout do Mercado Pago
      window.location.assign(data.init_point);

    } catch (err) {
      console.error('‚ùå Erro no pagamento:', err);
      alert('N√£o foi poss√≠vel iniciar o pagamento agora. Tente novamente.');
    } finally {
      // se preferir manter desabilitado at√© o redirect concluir, remova a linha abaixo
      btn.disabled = false;
    }
  }

  // Listeners de +/- quantidade
  document.querySelectorAll('.btn-qtd').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const itemNode = e.target.closest('.checkout-item');
      if (!itemNode) return;

      const itemId = itemNode.dataset.itemId;
      const action = e.target.dataset.action;
      const qtdSpan = itemNode.querySelector('.qtd');
      const qtdAtual = Number(qtdSpan.textContent);

      e.target.disabled = true;
      try {
        if (action === 'minus' && qtdAtual <= 1) {
          const resp = await fetch(`/api/carrinho/${itemId}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('Falha ao remover item.');
          itemNode.remove();
          marcarCarrinhoVazioSePrecisar();
        } else {
          const resp = await fetch(`/api/carrinho/${itemId}/${action}`, { method: 'POST' });
          if (!resp.ok) throw new Error('Falha ao atualizar quantidade.');
          const novaQtd = action === 'plus' ? (qtdAtual + 1) : (qtdAtual - 1);
          qtdSpan.textContent = String(novaQtd);
          atualizaSubtotalDoItem(itemNode);
        }
        recalculaTotalGeral();
      } catch (err) {
        console.error(err);
        alert('N√£o foi poss√≠vel atualizar este item agora.');
      } finally {
        e.target.disabled = false;
      }
    });
  });

  // Bind do bot√£o e estado inicial
  document.getElementById('btnPagarMP')?.addEventListener('click', pagarComMercadoPago);
  recalculaTotalGeral();
</script>
</body>
</html>
