
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Lista de Produtos</title>
  <link rel="stylesheet" href="/css/listings.css" />
</head>
<body>
  <!-- Navbar -->
  <%- include('partials/navbar.ejs') %>

  <main class="listagem-container">

        <% const selected = {
          marca: Array.isArray(query.marca) ? query.marca : query.marca ? [query.marca] : [],
          tipo: Array.isArray(query.tipo) ? query.tipo : query.tipo ? [query.tipo] : [],
          categoria: Array.isArray(query.categoria) ? query.categoria : query.categoria ? [query.categoria] : [],
          shape: Array.isArray(query.shape) ? query.shape : query.shape ? [query.shape] : [],
          condicao: query.condicao || '',
          preco_min: query.preco_min || '0',
          preco_max: query.preco_max || '100000',
          acabamento: query.acabamento || ''
        }; %>

        <% if (mensagens.length > 0) { %>
      <div class="flash-message">
        <%= mensagens[0] %>
      </div>
        <% } %>

    <form method="GET" action="/produtos">
    <!-- Filtros laterais -->
    <aside class="filtros">
      <h2>Filtrar por</h2>

      <div class="filtro-box">
        <h3>Pesquisa</h3>
     <input
  id="pesquisa"
  type="text"
  placeholder="Buscar instrumento..."
  name="pesquisa"
  value="<%= (query.pesquisa || '') %>"
/>
        <script>
  document.getElementById('pesquisa')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') e.target.form?.submit();
  });
</script>
      </div>

      <div class="filtro-box">
  <h3>Preço (R$)</h3>
  <div class="slider-preco">
    <span>Mín: <span id="preco-min">
      <%= Number(query.preco_min || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) %>
    </span></span>

    <input
      type="range"
      id="range-min"
      name="preco_min"
      min="0"
      max="<%= priceMaxBound %>"
      step="<%= priceStep %>"
      value="<%= Math.max(0, Math.min(Number(query.preco_min || 0), priceMaxBound)) %>"
    >

    <span>Máx: <span id="preco-max">
      <%= Number(Math.min(Number(query.preco_max || priceMaxBound), priceMaxBound))
          .toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) %>
    </span></span>

    <input
      type="range"
      id="range-max"
      name="preco_max"
      min="0"
      max="<%= priceMaxBound %>"
      step="<%= priceStep %>"
      value="<%= Math.max(0, Math.min(Number(query.preco_max || priceMaxBound), priceMaxBound)) %>"
    >
  </div>
</div>

      <div class="filtro-box">
        <label><input type="checkbox" name="promo"/> Produtos em Promoção</label>
      </div>
<div class="filtro-box">
  <h3>Tipo de Instrumento</h3>
  <select id="tipo-select" name="tipo">
    <option value="">Todos</option>
    <option value="corda"     <%= selected.tipo[0] === 'corda' ? 'selected' : '' %>>Corda</option>
    <option value="percussao" <%= selected.tipo[0] === 'percussao' ? 'selected' : '' %>>Percussão</option>
    <option value="teclado"   <%= selected.tipo[0] === 'teclado' ? 'selected' : '' %>>Teclado/Piano</option>
    <option value="sopro"     <%= selected.tipo[0] === 'sopro' ? 'selected' : '' %>>Sopro</option>
    <option value="audio"     <%= selected.tipo[0] === 'audio' ? 'selected' : '' %>>Áudio</option>
    <option value="acessorio" <%= selected.tipo[0] === 'acessorio' ? 'selected' : '' %>>Acessório</option>
  </select>
</div>
<div class="filtro-box" id="categoria-container" style="display:none">
  <h3>Categoria</h3>
  <select id="categoria-select" name="categoria">
    <option value="">Todas</option>
  </select>
</div>

<div class="filtro-box" id="shape-container" style="display:none">
  <h3>Shape</h3>
  <select id="shape-select" name="shape">
    <option value="">Todos</option>
  </select>
</div>

      <div class="filtro-box">
      <h3>Marca</h3>
      <label><input type="checkbox" name="marca[]" value="Fender" <%= selected.marca.includes('Fender') ? 'checked' : '' %>> Fender</label>
      <label><input type="checkbox" name="marca[]" value="Gibson" <%= selected.marca.includes('Gibson') ? 'checked' : '' %>> Gibson</label>
      <label><input type="checkbox" name="marca[]" value="Yamaha" <%= selected.marca.includes('Yamaha') ? 'checked' : '' %>> Yamaha</label>
      <label><input type="checkbox" name="marca[]" value="Ibanez" <%= selected.marca.includes('Ibanez') ? 'checked' : '' %>> Ibanez</label>
      <label><input type="checkbox" name="marca[]" value="Tagima" <%= selected.marca.includes('Tagima') ? 'checked' : '' %>> Tagima</label>
    </div>

      <!-- Cor -->
      <div class="filtro-box">
        <h3>Cor</h3>
        <select class="select-cor" name="cor">
          <option value="">Todas</option>
          <option value="Preto">Preto</option>
          <option value="Branco">Branco</option>
          <option value="Vermelho">Vermelho</option>
          <option value="Azul">Azul</option>
          <option value="Natural">Natural</option>
          <option value="Sunburst">Sunburst</option>
        </select>
      </div>

      <!-- Condição -->
      <div class="filtro-box">
        <h3>Condição</h3>
        <select name="condicao" class="select-condicao">
          <option value="">Todas</option>
          <option value="Novo (Lacrado)" <%= selected.condicao === 'Novo (Lacrado)' ? 'selected' : '' %>>Novo (Lacrado)</option>
          <option value="Usado - Estado de Novo" <%= selected.condicao === 'Usado - Estado de Novo' ? 'selected' : '' %>>Usado (Estado de Novo)</option>
          <option value="Usado - Com Leves Marcas" <%= selected.condicao === 'Usado - Com Leves Marcas' ? 'selected' : '' %>>Usado (Com Leves Marcas)</option>
          <option value="Usado - Sinais Evidentes" <%= selected.condicao === 'Usado - Sinais Evidentes' ? 'selected' : '' %>>Usado (Sinais Evidentes)</option>
          <option value="Defeituoso ou para peças" <%= selected.condicao === 'Defeituoso ou para peças' ? 'selected' : '' %>>Defeituoso / Para peças</option>
        </select>
      </div>

      <div class="filtro-box">
        <h3>Acabamento</h3>
        <select name="acabamento" class="select-acabamento">
          <option value="">Todos</option>
          <option value="Brilhante" <%= selected.acabamento === 'Brilhante' ? 'selected' : '' %>>Brilhante</option>
          <option value="Fosco" <%= selected.acabamento === 'Fosco' ? 'selected' : '' %>>Fosco</option>
          <option value="Satinado" <%= selected.acabamento === 'Satinado' ? 'selected' : '' %>>Satinado</option>
          <option value="Relíquia / Envelhecido" <%= selected.acabamento === 'Relíquia / Envelhecido' ? 'selected' : '' %>>Relíquia / Envelhecido</option>
        </select>
      </div> 


    <div class="filtro-box">
        <button type="submit" class="btn-filtrar">Aplicar Filtros</button>
        <a href="/produtos" class="btn-remover">Remover Filtros</a>
    </div>

    </aside>


    </form>

    <!-- Lista de produtos -->
    <section class="produtos">
      <h2>Instrumentos Disponíveis</h2>
      <% if (pagination.total > 0) { %>
    <div class="lista-head">
      <p class="count">
        Mostrando <%= pagination.startIndex %>–<%= pagination.endIndex %> de <%= pagination.total %>
      </p>
    </div>
  <% } %>

  <nav class="paginacao">
    <% if (pagination.total > 0 && pagination.totalPages > 1) { %>
      <a class="pag-btn <%= pagination.page === 1 ? 'disabled' : '' %>"
         href="/produtos<%= pagination.qs %>page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %>">« Anterior</a>

      <% for (let p = pagination.start; p <= pagination.end; p++) { %>
        <a class="pag-btn <%= p === pagination.page ? 'active' : '' %>"
           href="/produtos<%= pagination.qs %>page=<%= p %>&limit=<%= pagination.limit %>"><%= p %></a>
      <% } %>

      <a class="pag-btn <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>"
         href="/produtos<%= pagination.qs %>page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %>">Próxima »</a>
    <% } %>
  </nav>

      <div class="grid-produtos">
        <% produtos.forEach(item => { %>
          <div class="card-produto">
            <div class="mini-galeria">
              <div class="carousel">
                <% if (item.imagem_url) { 
                    const imagens = item.imagem_url.split(','); %>
                  
                  <div class="carousel-wrapper">
                    <% imagens.forEach((url, index) => { %>
                      <img class="carousel-img <% if (index === 0) { %>active<% } %>" src="<%= url.trim() %>" alt="Imagem <%= index + 1 %>">
                    <% }) %>
                  </div>

                  <div class="carousel-controls">
                    <button class="prev">&#10094;</button>
                    <button class="next">&#10095;</button>
                  </div>

                <% } else { %>
                  <p style="color: #aaa; font-size: 12px;">(sem imagens)</p>
                <% } %>
              </div>
            </div>
            <h4><%= item.nome %></h4>
            <p><strong>Preço:</strong> <%= Number(item.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %></p>
            <p class="tags"><strong>Tags:</strong> <%= item.tags %></p>
            <a href="/item/<%= item.id %>?voltar=<%= encodeURIComponent(urlAtual) %>">
              <button class="btn-vermais">Ver mais</button>
            </a>
          </div>
        <% }) %>
      </div>
        <nav class="paginacao">
    <% if (pagination.total > 0 && pagination.totalPages > 1) { %>
      <a class="pag-btn <%= pagination.page === 1 ? 'disabled' : '' %>"
         href="/produtos<%= pagination.qs %>page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %>">« Anterior</a>

      <% for (let p = pagination.start; p <= pagination.end; p++) { %>
        <a class="pag-btn <%= p === pagination.page ? 'active' : '' %>"
           href="/produtos<%= pagination.qs %>page=<%= p %>&limit=<%= pagination.limit %>"><%= p %></a>
      <% } %>

      <a class="pag-btn <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>"
         href="/produtos<%= pagination.qs %>page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %>">Próxima »</a>
    <% } %>
  </nav>
    </section>
  </main>

  <!-- Footer -->
  <%- include('partials/footer.ejs') %>
  <script>
  document.querySelectorAll('.carousel').forEach(carousel => {
    const images = carousel.querySelectorAll('.carousel-img');
    const nextBtn = carousel.querySelector('.next');
    const prevBtn = carousel.querySelector('.prev');

    let currentIndex = 0;

    const showImage = index => {
      images.forEach((img, i) => {
        img.classList.toggle('active', i === index);
      });
    };

    if (nextBtn && prevBtn && images.length > 0) {
      nextBtn.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % images.length;
        showImage(currentIndex);
      });

      prevBtn.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(currentIndex);
      });
    }

    showImage(currentIndex);
  });
</script>

<script>
  const rangeMin = document.getElementById('range-min');
  const rangeMax = document.getElementById('range-max');
  const precoMinLabel = document.getElementById('preco-min');
  const precoMaxLabel = document.getElementById('preco-max');

  function formatarValor(valor) {
    return Number(valor).toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2
    });
  }

  function clampRanges() {
    const minVal = Number(rangeMin.value);
    const maxVal = Number(rangeMax.value);
    if (minVal > maxVal) {
      rangeMax.value = minVal; // impede cruzar
    }
  }

  function syncLabels() {
    precoMinLabel.textContent = formatarValor(rangeMin.value);
    precoMaxLabel.textContent = formatarValor(rangeMax.value);
  }

  // inicia labels corretas
  syncLabels();

  rangeMin.addEventListener('input', () => {
    clampRanges();
    syncLabels();
  });

  rangeMax.addEventListener('input', () => {
    clampRanges();
    syncLabels();
  });
</script>


<script>
  // Estado inicial do servidor
  const selectedFromServer = <%- JSON.stringify(selected) %>;

  // Mapa Tipo -> Categorias (ajuste para sua taxonomia real)
  const MAP_CATEGORIAS = {
    corda:     ['violao', 'guitarra', 'piano', 'baixo'],
    percussao: ['bateria', 'percussao_mano', 'eletronica'],
    teclado:   ['piano', 'teclado', 'sintetizador'],
    sopro:     ['saxofone', 'trompete', 'flauta', 'clarinete'],
    audio:     ['interface', 'monitor', 'microfone', 'fone'],
    acessorio: ['correia', 'cabo', 'case', 'palheta']
  };

  // Mapa inverso Categoria -> Tipo (para auto-selecionar tipo se a URL já vier com categoria)
  const CAT_TO_TIPO = Object.entries(MAP_CATEGORIAS).reduce((acc,[tipo,cats])=>{
    cats.forEach(c => acc[c]=tipo);
    return acc;
  }, {});

  // Shapes: só quando categoria = 'guitarra'
  const SHAPES_GUITARRA = ['Stratocaster','Telecaster','Les Paul','SG','Explorer','Flying V'];

  // Helpers
  const $ = s => document.querySelector(s);
  const toTitle = str => (str||'').replace(/_/g,' ').replace(/(^|\s)\S/g, s => s.toUpperCase());
  function populateSelect(selectEl, values, {placeholder='Todos', selected=''} = {}) {
    const prev = selectEl.value;
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = toTitle(v);
      selectEl.appendChild(opt);
    });
    const wanted = String(selected || prev || '');
    if ([...selectEl.options].some(o => o.value === wanted)) {
      selectEl.value = wanted;
    }
  }

  // Elementos
  const tipoSel   = $('#tipo-select');
  const catWrap   = $('#categoria-container');
  const catSel    = $('#categoria-select');
  const shapeWrap = $('#shape-container');
  const shapeSel  = $('#shape-select');

  function showCategoria(show) { catWrap.style.display = show ? '' : 'none'; }
  function showShape(show)     { shapeWrap.style.display = show ? '' : 'none'; }

  function renderCategorias() {
    const tipo = tipoSel.value || '';

    if (!tipo) {
      // Sem tipo: oculta Categoria e reseta valores
      showCategoria(false);
      catSel.value = '';
      renderShapes('');
      return;
    }

    // Com tipo: mostra Categoria e popula conforme o tipo
    const cats = MAP_CATEGORIAS[tipo] || [];
    showCategoria(true);
    populateSelect(catSel, cats, {
      placeholder: 'Todas',
      selected: (selectedFromServer.categoria && selectedFromServer.categoria[0]) || ''
    });

    // Se a categoria atual não pertence ao tipo, limpa
    if (catSel.value && !cats.includes(catSel.value)) {
      catSel.value = '';
    }

    renderShapes(catSel.value);
  }

  function renderShapes(categoria) {
    if (categoria === 'guitarra') {
      showShape(true);
      populateSelect(shapeSel, SHAPES_GUITARRA, {
        placeholder: 'Todos',
        selected: (selectedFromServer.shape && selectedFromServer.shape[0]) || ''
      });
    } else {
      showShape(false);
      shapeSel.innerHTML = '<option value="">Todos</option>';
    }
  }

  // Inicialização
  (function initCascata() {
    // Caso a URL traga categoria mas não traga tipo, deduz o tipo e seleciona
    let tipoInicial = (Array.isArray(selectedFromServer.tipo) ? selectedFromServer.tipo[0] : selectedFromServer.tipo) || '';
    const catInicial = (Array.isArray(selectedFromServer.categoria) ? selectedFromServer.categoria[0] : selectedFromServer.categoria) || '';

    if (!tipoInicial && catInicial && CAT_TO_TIPO[catInicial]) {
      tipoInicial = CAT_TO_TIPO[catInicial];
    }
    if (tipoInicial) tipoSel.value = tipoInicial;

    renderCategorias();

    tipoSel.addEventListener('change', () => {
      selectedFromServer.categoria = [];
      selectedFromServer.shape = [];
      renderCategorias();
    });

    catSel.addEventListener('change', () => {
      renderShapes(catSel.value);
    });
  })();
</script>


</body>
</html>
