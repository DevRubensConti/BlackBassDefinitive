<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minhas Vendas</title>
  <link rel="stylesheet" href="/css/minhas-vendas.css">
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="vendas-container">
    <h1>ğŸ“¦ Minhas Vendas</h1>

    <% if (vendas && vendas.length) { %>
      <section class="vendas-grid">
        <% vendas.forEach(venda => { 
             const itens = venda.itens || [];
             const primeiroItem = itens[0] || {};
             const img = primeiroItem.imagem_url || '/images/placeholder.png';
        %>
          <div class="venda-card">
            <!-- CabeÃ§alho do pedido -->
            <header class="venda-header">
              <div>
                <h3>CÃ³digo do pedido: <span><%= venda.codigo || ('#' + venda.id) %></span></h3>
                <p>
                  <strong>Status:</strong> 
                  <span class="badge-status"><%= venda.status %></span>
                </p>
                <p>
                  <strong>Data:</strong> 
                  <%= venda.data ? new Date(venda.data).toLocaleDateString('pt-BR') : '-' %>
                </p>
              </div>
              <div class="venda-total">
                <p><strong>Total:</strong></p>
                <p class="valor-total">
                  <%= Number(venda.total || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                </p>
              </div>
            </header>

            <div class="venda-body">
              <!-- Imagem principal (primeiro item) -->
              <div class="venda-img">
                <% if (primeiroItem && primeiroItem.imagem_url) { %>
                  <img src="<%= img %>" alt="Produto">
                <% } else { %>
                  <div class="no-img">Sem imagem</div>
                <% } %>
              </div>

              <!-- Lista de itens da venda -->
              <div class="venda-itens">
                <% if (itens.length) { %>
                  <ul>
                    <% itens.forEach(item => { %>
                      <li class="venda-item-linha">
                        <div class="venda-item-info">
                          <span class="item-nome"><%= item.nome || 'Produto' %></span>
                          <span class="item-qtd">Qtd: <%= item.quantidade %></span>
                        </div>
                        <div class="venda-item-valores">
                          <span class="item-preco-unit">
                            <%= Number(item.unitario || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %> un.
                          </span>
                          <span class="item-subtotal">
                            <%= Number(item.subtotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                          </span>
                        </div>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="nenhum-item">Nenhum item encontrado para este pedido.</p>
                <% } %>
              </div>
            </div>

            <!-- AÃ§Ãµes: gerar / ver etiqueta -->
            <footer class="venda-footer">
              <% if (venda.me_label_url) { %>
                <!-- Etiqueta jÃ¡ com link salvo -->
                <a href="<%= venda.me_label_url %>" target="_blank" class="btn btn-primario">
                  ğŸ§¾ Ver etiqueta
                </a>
              <% } else if (venda.me_order_id) { %>
                <!-- JÃ¡ criou envio no Melhor Envio, mas ainda sem URL salva -->
                <button type="button" class="btn btn-disabled" disabled>
                  â³ Etiqueta em processamento no Melhor Envio
                </button>
              <% } else { %>
                <!-- Ainda nÃ£o gerou nada -->
                <form 
                  method="POST" 
                  action="/minhas-vendas/<%= venda.id %>/gerar-etiqueta"
                  class="venda-actions"
                >
                  <button type="submit" class="btn btn-secundario">
                    ğŸ“¦ Gerar etiqueta
                  </button>
                </form>
              <% } %>
            </footer>
          </div>
        <% }) %>
      </section>
    <% } else { %>
      <p class="no-vendas">VocÃª ainda nÃ£o realizou nenhuma venda.</p>
    <% } %>
  </main>

  <%- include('partials/footer.ejs') %>
</body>
</html>
