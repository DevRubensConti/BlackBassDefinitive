<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout ‚Äî BlackBass</title>
  <link rel="stylesheet" href="/css/checkout_bricks.css">
</head>
<body>
  <%- include('partials/navbar.ejs') %>

  <main class="bb-checkout-page">
    <section class="bb-checkout-container">
      <header class="bb-checkout-header">
        <div>
          <h1 class="bb-checkout-title">Finalizar pagamento</h1>
          <p class="bb-checkout-subtitle">
            Revise o valor total e conclua seu pagamento com seguran√ßa pelo Mercado Pago.
          </p>
        </div>

        <div class="bb-total-pill">
          <span>Total da compra</span>
          <strong><%= Number(totalAmount).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %></strong>
        </div>
      </header>

      <div class="bb-checkout-grid">
        <!-- RESUMO DA COMPRA -->
        <aside class="bb-summary-card">
          <h2>Resumo da compra</h2>

          <% if (itensCarrinho && itensCarrinho.length) { %>
            <ul class="bb-summary-list">
              <% itensCarrinho.forEach(row => { 
                   const prod = row.produtos || {};
                   const qtd  = Number(row.quantidade || 1);
                   const preco = Number(prod.preco || 0);
              %>
                <li class="bb-summary-item">
                  <div class="bb-summary-item-name">
                    <%= prod.nome || 'Item' %>
                  </div>
                  <div class="bb-summary-item-qty">
                    x<%= qtd %>
                  </div>
                  <div class="bb-summary-item-price">
                    <%= Number(qtd * preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="bb-summary-note">N√£o foi poss√≠vel carregar o detalhamento dos itens.</p>
          <% } %>

          <div class="bb-summary-footer">
            <div class="bb-summary-total-line">
              <span>Total</span>
              <span><%= Number(totalAmount).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %></span>
            </div>
            <p class="bb-summary-note">
              O pagamento √© processado pelo Mercado Pago. Seus dados de cart√£o n√£o ficam salvos no BlackBass.
            </p>
          </div>

          <a href="/carrinho" class="bb-back-cart">
            <span>‚Üê</span>
            <span>Voltar para o carrinho</span>
          </a>
        </aside>

        <!-- PAGAMENTO (BRICKS) -->
        <section class="bb-payment-card">
          <h2>Pagamento com cart√£o</h2>
          <p class="bb-payment-subtitle">
            Preencha os dados do cart√£o no formul√°rio seguro abaixo. Voc√™ ser√° redirecionado automaticamente ap√≥s a aprova√ß√£o.
          </p>

          <div id="cardPaymentBrick_container">
            <div class="bb-brick-loading">
              <div class="bb-spinner"></div>
              <span>Carregando formul√°rio de pagamento...</span>
            </div>
          </div>

          <div class="bb-payment-security">
            <div class="bb-payment-chip">
              <span class="emoji">üîí</span>
              <span>Ambiente seguro Mercado Pago</span>
            </div>
            <div class="bb-payment-chip">
              <span class="emoji">üí≥</span>
              <span>Cart√£o de cr√©dito e d√©bito</span>
            </div>
            <div class="bb-payment-chip">
              <span class="emoji">üìÑ</span>
              <span>Comprovante enviado para seu e-mail</span>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>
  <%- include('partials/footer.ejs') %>
  

  <!-- SDK do Mercado Pago -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script>
    // Public key vinda do backend
    const mp = new MercadoPago("<%= mpPublicKey %>", {
      locale: "pt-BR",
    });

    const bricksBuilder = mp.bricks();

    async function renderCardPaymentBrick() {
      const settings = {
        initialization: {
          amount: <%= totalAmount %>, // valor total do carrinho
        },
        customization: {
          visual: {
            style: {
              theme: "default", // 'default' | 'dark' | 'bootstrap' | 'flat'
            },
          },
        },
        callbacks: {
          onSubmit: (cardFormData) => {
            // Envia pro backend processar o pagamento
            return new Promise((resolve, reject) => {
              fetch("/api/checkout/bricks/process-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  ...cardFormData,
                  amount: <%= totalAmount %>,
                }),
              })
                .then(async (resp) => {
                  let data = {};
                  try {
                    data = await resp.json();
                  } catch (e) {
                    console.warn("Resposta sem JSON ou inv√°lida:", e);
                  }

                  if (!resp.ok) {
                    console.error("Erro HTTP do backend:", resp.status, data);
                    window.location.href = "/api/checkout/erro";
                    return resolve();
                  }

                  console.log("Resposta backend Bricks:", data);

                  // Trata status do pagamento
                  if (data.status === "approved") {
                    window.location.href = "/api/checkout/sucesso";
                  } else if (
                    data.status === "in_process" ||
                    data.status === "pending"
                  ) {
                    window.location.href = "/api/checkout/pendente";
                  } else {
                    window.location.href = "/api/checkout/erro";
                  }

                  resolve();
                })
                .catch((error) => {
                  console.error("Erro de rede/backend no Brick:", error);
                  window.location.href = "/api/checkout/erro";
                  reject(error);
                });
            });
          },
          onReady: () => {
            console.log("Card Payment Brick pronto");
            // Remove loading quando o brick estiver pronto
            const loadingEl = document.querySelector('.bb-brick-loading');
            if (loadingEl) loadingEl.style.display = 'none';
          },
          onError: (error) => {
            console.error("Erro no Brick:", error);
          },
        },
      };

      // Cria o Brick dentro do container
      window.cardPaymentBrickController = await bricksBuilder.create(
        "cardPayment",
        "cardPaymentBrick_container",
        settings
      );
    }

    renderCardPaymentBrick();
  </script>
  
</body>
</html>
