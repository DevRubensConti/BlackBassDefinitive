<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro Pessoa Física</title>
  <link rel="stylesheet" href="/css/signup.css">
  <style>
    /* ADDED: feedback simples de loading e bloqueio durante a busca do CEP */
    .mensagem-erro.topo { margin-bottom: 12px; }
    .campo-bloqueado { background: #f6f6f6; }
    .hint { font-size: 12px; color:#666; margin-top:4px; }
  </style>
</head>
<body>
<%- include('partials/navbar.ejs') %>

<main class="form-etapas-wrapper">
  <% if (mensagemErro) { %>
  <div class="erro-cadastro">
    <p><%= mensagemErro %></p>
  </div>
  <% } %>

  <div id="mensagem-erro-pf" class="mensagem-erro topo" style="display: none;"></div>

  <h2><u>Cadastro - Pessoa Física</u></h2>

  <form id="form-pf" method="POST" action="/cadastro-pf" autocomplete="off">
    <details id="etapa-1" open>
      <summary>Etapa 1 - Informações Pessoais</summary>

      <div class="form-row">
        <div class="form-group">
          <label for="nome">Nome</label>
          <input type="text" id="nome" name="nome" required autocomplete="given-name">
        </div>
        <div class="form-group">
          <label for="sobrenome">Sobrenome</label>
          <input type="text" id="sobrenome" name="sobrenome" required autocomplete="family-name">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="cpf">CPF</label>
          <input type="text" id="cpf" name="cpf" required inputmode="numeric" autocomplete="off" placeholder="000.000.000-00">
          <div class="hint">Formato: 000.000.000-00</div>
        </div>
        <div class="form-group">
          <label for="data_nascimento">Data de Nascimento</label>
          <input type="date" id="data_nascimento" name="data_nascimento" required autocomplete="bday">
        </div>
      </div>

      <button type="button" onclick="desbloquearEtapaProxima('etapa-1', 'etapa-2')">Continuar</button>
    </details>

    <details id="etapa-2">
      <summary>Etapa 2 - Contato e Acesso</summary>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="email" placeholder="seuemail@exemplo.com">
        </div>
        <div class="form-group">
          <label for="senha">Senha</label>
          <div class="senha-wrapper">
            <input type="password" id="senha" name="senha" placeholder="Crie sua senha" required autocomplete="new-password">
            <img id="icone-senha" src="/images/eye-closed.png" alt="Mostrar senha" style="cursor:pointer;" onclick="toggleSenha()">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="telefone">Telefone</label>
          <input type="text" id="telefone" name="telefone" required inputmode="tel" autocomplete="tel" placeholder="(00) 90000-0000">
        </div>
      </div>

      <button type="button" onclick="desbloquearEtapaProxima('etapa-2', 'etapa-3')">Continuar</button>
    </details>

    <details id="etapa-3">
      <summary>Etapa 3 - Endereço</summary>

      <div class="form-row">
        <div class="form-group">
          <label for="estado">Estado</label>
          <select id="estado" name="estado" required autocomplete="address-level1">
            <option value="">Selecione o estado</option>
            <option value="AC">Acre</option><option value="AL">Alagoas</option>
            <option value="AP">Amapá</option><option value="AM">Amazonas</option>
            <option value="BA">Bahia</option><option value="CE">Ceará</option>
            <option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option>
            <option value="GO">Goiás</option><option value="MA">Maranhão</option>
            <option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option>
            <option value="MG">Minas Gerais</option><option value="PA">Pará</option>
            <option value="PB">Paraíba</option><option value="PR">Paraná</option>
            <option value="PE">Pernambuco</option><option value="PI">Piauí</option>
            <option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option>
            <option value="RS">Rio Grande do Sul</option><option value="RO">Rondônia</option>
            <option value="RR">Roraima</option><option value="SC">Santa Catarina</option>
            <option value="SP">São Paulo</option><option value="SE">Sergipe</option>
            <option value="TO">Tocantins</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cidade">Cidade</label>
          <input type="text" id="cidade" name="cidade" placeholder="Sua cidade" required autocomplete="address-level2">
        </div>

        <div class="form-group">
          <label for="cep">CEP</label>
          <input type="text" id="cep" name="cep" placeholder="00000-000" required inputmode="numeric" autocomplete="postal-code">
          <div id="cep-status" class="hint"></div> <!-- ADDED -->
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="endereco">Endereço</label>
          <input type="text" id="endereco" name="endereco" placeholder="Rua / Avenida" required autocomplete="address-line1">
        </div>
        <div class="form-group">
          <label for="numero">Número</label>
          <input type="text" id="numero" name="numero" placeholder="Número" required autocomplete="address-line2">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="bairro">Bairro</label>
          <input type="text" id="bairro" name="bairro" placeholder="Seu bairro" required>
        </div>
        <div class="form-group">
          <label for="complemento">Complemento (Opcional)</label>
          <input type="text" id="complemento" name="complemento" placeholder="Apto, Bloco, Referência...">
        </div>
      </div>

      <button type="submit">Finalizar Cadastro</button>
    </details>
  </form>
</main>

<%- include('partials/footer.ejs') %>

<script>
  // ===== Helpers de etapa (inclui inputs e selects) =====
  function desbloquearEtapaProxima(atual, proxima) {
    const campos = document.querySelectorAll(
      `#${atual} input:required, #${atual} select:required, #${atual} textarea:required`
    );
    let preenchido = true;
    campos.forEach(input => { if (!input.value.trim()) preenchido = false; });

    // Validação extra para CPF na Etapa 1
    if (atual === 'etapa-1') {
      const cpfInput = document.getElementById('cpf');
      if (!validarCPF(cpfInput.value)) {
        alert('CPF inválido. Verifique e tente novamente.');
        return;
      }
    }

    if (preenchido) {
      document.getElementById(atual).removeAttribute('open');
      document.getElementById(proxima).setAttribute('open', true);
      document.getElementById(proxima).scrollIntoView({ behavior: 'smooth' });
    } else {
      alert('Por favor, preencha todos os campos obrigatórios.');
    }
  }

  function etapaPreenchida(idEtapa) {
    const campos = document.querySelectorAll(
      `#${idEtapa} input:required, #${idEtapa} select:required, #${idEtapa} textarea:required`
    );
    for (let campo of campos) { if (!campo.value.trim()) return false; }
    return true;
  }

  document.getElementById('etapa-2').addEventListener('toggle', function () {
    if (this.open && !etapaPreenchida('etapa-1')) {
      alert('Por favor, preencha todos os campos da Etapa 1 antes.');
      this.open = false;
    }
  });

  document.getElementById('etapa-3').addEventListener('toggle', function () {
    if (this.open && !etapaPreenchida('etapa-2')) {
      alert('Por favor, preencha todos os campos da Etapa 2 antes.');
      this.open = false;
    }
  });

  // ===== Máscaras CPF / Telefone / CEP =====
  const cpfInput = document.getElementById('cpf');
  if (cpfInput) {
    cpfInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value.slice(0, 14);
    });
  }

  document.getElementById('telefone').addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 10) {
      value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    } else {
      value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    e.target.value = value.slice(0, 15);
  });

  const cepInput = document.getElementById('cep');
  cepInput.addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value.slice(0, 9);
  });

  // ===== Validação CPF =====
  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g,'');
    if (cpf === '' || cpf.length !== 11) return false;
    if (/^(\d)\1+$/.test(cpf)) return false;
    let soma = 0, resto;

    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;

    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    return resto === parseInt(cpf.substring(10, 11));
  }

  // ===== CEP Auto-complete (ViaCEP) =====
  const estadoSelect = document.getElementById('estado');
  const cidadeInput = document.getElementById('cidade');
  const enderecoInput = document.getElementById('endereco');
  const bairroInput = document.getElementById('bairro');
  const cepStatus = document.getElementById('cep-status');

  function setEnderecoLoading(isLoading) {
    [estadoSelect, cidadeInput, enderecoInput, bairroInput].forEach(el => {
      el.disabled = isLoading;
      el.classList.toggle('campo-bloqueado', isLoading);
    });
    cepStatus.textContent = isLoading ? 'Buscando endereço pelo CEP…' : '';
  }

  function limparEndereco() {
    cidadeInput.value = '';
    enderecoInput.value = '';
    bairroInput.value = '';
    estadoSelect.value = '';
  }

  async function buscarCEP(cepNumerico) {
    try {
      setEnderecoLoading(true);
      const res = await fetch(`https://viacep.com.br/ws/${cepNumerico}/json/`);
      const data = await res.json();
      if (data.erro) throw new Error('CEP não encontrado.');
      enderecoInput.value = data.logradouro || '';
      bairroInput.value = data.bairro || '';
      cidadeInput.value = data.localidade || '';
      estadoSelect.value = data.uf || '';
      cepStatus.textContent = 'Endereço preenchido automaticamente.';
      document.getElementById('numero').focus();
    } catch (err) {
      limparEndereco();
      cepStatus.textContent = 'Não foi possível encontrar este CEP. Preencha manualmente.';
    } finally {
      setEnderecoLoading(false);
    }
  }

  let cepDebounce;
  cepInput.addEventListener('blur', () => {
    const cepNum = cepInput.value.replace(/\D/g, '');
    if (cepNum.length === 8) buscarCEP(cepNum);
  });
  cepInput.addEventListener('keyup', () => {
    clearTimeout(cepDebounce);
    const cepNum = cepInput.value.replace(/\D/g, '');
    if (cepNum.length === 8) {
      cepDebounce = setTimeout(() => buscarCEP(cepNum), 400);
    }
  });

  // ===== Validação no submit =====
  document.getElementById('form-pf').addEventListener('submit', function (e) {
    const erros = [];
    const mensagemErro = document.getElementById('mensagem-erro-pf');
    mensagemErro.style.display = 'none';
    mensagemErro.innerHTML = '';

    const cpfVal = document.getElementById('cpf')?.value || '';
    if (!validarCPF(cpfVal)) {
      erros.push('CPF inválido');
    }

    const cep = document.getElementById('cep')?.value?.trim() || '';
    if (!/^\d{5}-\d{3}$/.test(cep)) erros.push('CEP inválido (use o formato 00000-000)');

    const telDigits = (document.getElementById('telefone')?.value || '').replace(/\D/g,'');
    if (telDigits.length < 10) erros.push('Telefone inválido');

    const email = document.getElementById('email')?.value?.trim() || '';
    if (!email.includes('@')) erros.push('E-mail inválido');

    if (!estadoSelect.value) erros.push('Selecione o Estado (UF)');

    if (erros.length > 0) {
      e.preventDefault();
      mensagemErro.innerHTML = 'Cadastro não foi possível pois:<br>– ' + erros.join('<br>– ');
      mensagemErro.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // ===== Mostrar/ocultar senha (ícone corrigido) =====
  function toggleSenha() {
    const senhaInput = document.getElementById('senha');
    const icone = document.getElementById('icone-senha');
    const vaiMostrar = senhaInput.type === 'password';
    senhaInput.type = vaiMostrar ? 'text' : 'password';
    icone.src = vaiMostrar ? '/images/eye-open.png' : '/images/eye-closed.png';
    icone.alt = vaiMostrar ? 'Esconder senha' : 'Mostrar senha';
  }
  window.toggleSenha = toggleSenha; // garante acesso no onclick
</script>

</body>
</html>
