<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Assinar plano</title>
  <!-- SDK Mercado Pago -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>
  <h2>Assinar plano: <%= plano.nome %></h2>
  <p>Valor: R$ <%= (plano.preco_cents / 100).toFixed(2) %> / <%= plano.periodicidade %></p>

  <!-- Container onde o Brick vai entrar -->
  <div id="subscription-payment-brick"></div>

  <script>
  const planoId = '<%= plano.id %>';
  const payerEmail = '<%= usuario.email %>';
  const publicKey = '<%= MP_PUBLIC_KEY %>';

  console.log('[SUBS][VIEW] planoId=', planoId, 'payerEmail=', payerEmail, 'PK=', publicKey);

  const mp = new MercadoPago(publicKey, { locale: 'pt-BR' });

  (async function initBrick() {
    const bricksBuilder = mp.bricks();

    await bricksBuilder.create('cardPayment', 'subscription-payment-brick', {
      initialization: {
        amount: <%= plano.preco_cents / 100 %>,
        payer: { email: payerEmail }
      },
      callbacks: {
        // âœ… Agora usando cardFormData, como a doc do Brick
        onSubmit: (cardFormData) => {
          console.log('[SUBS][onSubmit] cardFormData:', cardFormData);

          return new Promise(async (resolve, reject) => {
            try {
              const { token, payer } = cardFormData;

              const resp = await fetch('/assinaturas/subscribe-brick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  planoId,
                  cardTokenId: token,          // token gerado pelo Brick
                  payerEmail: payer.email      // email do pagador
                })
              });

              const json = await resp.json();
              console.log('[SUBS][onSubmit] resp', resp.status, json);

              if (!resp.ok || !json.ok) {
                alert(json.error || 'Erro ao criar assinatura, tente novamente.');
                return reject(json);
              }

              resolve(); // avisa o Brick que deu certo
              window.location.href = '/minha-conta?ok=assinatura_criada';
            } catch (err) {
              console.error('[SUBS][onSubmit] erro', err);
              alert('Erro ao processar pagamento.');
              reject(err);
            }
          });
        },
        onError: (error) => {
          console.error('[SUBS][Brick onError]', error);
          alert('Erro ao inicializar pagamento.');
        }
      }
    });
  })();
</script>

</body>
</html>
