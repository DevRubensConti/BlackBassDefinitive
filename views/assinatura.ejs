<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Assinar Plano</title>

  <!-- SDK Mercado Pago -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    #subscription-payment-brick {
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <h2>Assinar plano: <%= plano.nome %></h2>
  <p>
    Valor: <strong>R$ <%= (plano.preco_cents / 100).toFixed(2) %></strong> / <%= plano.periodicidade %>
  </p>

  <!-- Container onde o Brick serÃ¡ renderizado -->
  <div id="subscription-payment-brick"></div>

<script>
  const planoId   = '<%= plano.id %>';
  const payerEmail = '<%= usuario.email %>';
  const publicKey  = '<%= MP_PUBLIC_KEY %>';

  console.log('[SUBS][VIEW] planoId=', planoId, 'payerEmail=', payerEmail, 'PK=', publicKey);

  const mp = new MercadoPago(publicKey, { locale: 'pt-BR' });
  const bricksBuilder = mp.bricks();

  const renderCardPaymentBrick = async () => {
    await bricksBuilder.create('cardPayment', 'paymentBrick_container', {
      initialization: {
        amount: <%= plano.preco_cents %> / 100,
        payer: {
          email: payerEmail
        }
      },
      callbacks: {
        // ðŸ‘‰ OBRIGATÃ“RIOS pra tirar o erro
        onReady: () => {
          console.log('[SUBS][VIEW] Payment Brick pronto');
          // aqui vocÃª pode esconder spinner de â€œcarregandoâ€, se tiver
        },
        onSubmit: (cardFormData) => {
          console.log('[SUBS][VIEW] onSubmit', cardFormData);

          // Exemplo de envio pro backend:
          return new Promise((resolve, reject) => {
            fetch('/assinaturas/subscribe-brick', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                planoId: planoId,
                payerEmail: payerEmail,
                cardFormData
              })
            })
              .then(res => res.json())
              .then(json => {
                if (!json.ok) {
                  console.error('[SUBS][VIEW] Erro ao assinar', json);
                  return reject(json);
                }
                alert('Assinatura criada com sucesso!');
                resolve();
              })
              .catch(err => {
                console.error('[SUBS][VIEW] Erro fetch subscribe-brick', err);
                reject(err);
              });
          });
        },
        onError: (error) => {
          console.error('[SUBS][VIEW] Erro no Payment Brick', error);
          alert('Ocorreu um erro ao carregar o pagamento. Tente novamente.');
        }
      }
    });
  };

  renderCardPaymentBrick();
</script>


</body>
</html>
